# VRChat クソでっけぇプッシャーゲーム効率化

## 概要

でかプガチ勢向け効率化スクリプトです。クソでっけぇプッシャーゲーム同好会のグループインスタンスの中で一番人数が多いインスタンスにいるかをチェックして、いない場合は最多人数インスタンスへの自己インバイトを送信します。またVRChat自体がハングアップして落ちたり、通信エラー（接続タイムアウト）などで落ちたことを検知して自動でVRChatを再起動まで行います。

[クソでっけえプッシャーゲーム同好会](https://vrc.group/DEKAPU.9809)

## 動作仕様

### 1. VRChatが落ちている場合

- 指定プロファイルのVRChatが起動していないことを検知すると、自動的にVRChatを起動します。

### 2. ユーザー状態の監視

- **オフライン状態（ロスコネ）検知**
  - VRChatサーバーとの接続がタイムアウトすることがある問題への対策です。
  - 3回連続でオフライン状態が続いた場合は強制的にVRChat再起動します。

- **移動中（Traveling）の監視**
  - ごくまれにJoining表示が無限に続くことがある問題への対策です。
  - 3分以上Joining状態が続いた場合は強制的にVRChat再起動します。

### 3. 現在のワールドチェック

- でかプのワールドにいるか確認します。いない場合はエラーになります。

### 4. インスタンス人数チェック

- グループインスタンス一覧を取得し、ユーザーが最多人数のインスタンスにいるかチェックします
  - 最大人数との現在のワールド人数の差分に応じて以下の動作をします。
    - 差分が8人未満 → ほぼ最多と判定（移動しても効率がほぼ変わらないため）
    - 差分が8人以上 → 自己インバイトを自動で送信

### ※自動起動時のジョイン可能インスタンス探索の仕様

- 優先順位
  1. グループ内のインスタンス
  2. パブリックインスタンス

- 条件
  - ユーザー数が定員 -1 以下（Joinできる余裕があるか）
  - インスタンスがクローズしていないこと

- 該当するインスタンスがあればそのインスタンスを指定してVRChatを起動します。
- 当該インスタンスがない場合は指定なし（ホームワールド）で起動します。

## 動作環境

Windows環境でのみ動作します。事前にPythonとuvをインストールしておく必要があります。

[Install Python](https://www.python.org/downloads/)
[Install uv](https://github.com/astral-sh/uv)

### 【注意】VRChatのインストール先を変更している方へ

VRChatのインストール先をデフォルトから変更している方は`app/util/launcher.py`の定義を手動で修正してください。ソースコード内のデフォルトは以下のパスになっています。

`C:/Program Files (x86)/Steam/steamapps/common/VRChat/launch.exe`

## 使用方法

### 事前準備

#### TOTPシークレットの取得

本ツールではVRChat APIを使用するためVRChatの認証情報が必要となります。その際にTOTPによる２段階認証の設定が必要となります。既にTOTPベースの2段階認証が有効な方でTOTP生成アプリからシークレットを抜き出せる方は以下の手順をスキップしてください。（Eメールベースの2段階認証の場合、本ツールは使用できません。必ずTOTPベースの2段階認証が必須です。）

1. 2段階認証の無効化
   TOTPシークレットを再取得するために一時的に2段階認証を無効化する必要があります。
   Webブラウザから[VRChat](https://vrchat.com/home/login)にログインしてアカウントの設定から2段階認証を無効化してください。

2. 2段階認証の有効化
   再度2段階認証を有効化する手順を行いTOTP設定用のQRコードを表示させてください。
   そのQRコードを任意のQRコードリーダーで読み取りその中のクエリパラメータ`secret`の値がTOTP_SECRETとなりますので値を控えておいてください。
   また普段使っているTOTP生成アプリにも普段通りTOTPを登録してください。

---

1. VRChat Quick Launcherで専用の新規プロファイルを作成して起動したあと、ログインまで済ませてください。この際のプロファイル番号を次の手順で使うため控えておいてください。

2. `.env`を作成して以下の情報を入れてください

- ID
- PASSWORD
- TOTP_SECRET
- USER_ID (usr_から始まるユーザーID)
- PROFILE (VRChat Quick Launcherで作成したプロファイル番号)

### 実行方法

ターミナルから以下のコマンドで実行できます。

`uv run .\main.py`

## 免責事項

このツールを使用して生じるいかなる損害につきましては責任を負いかねます。
VRChat APIを利用するためAPIのレート制限にはご注意ください。
